"""
Individual tab components for the weather dashboard - Refactored to reduce duplication
"""
import tkinter as tk
from tkinter import ttk, messagebox
from .components import StyledButton, StyledText, StyledLabel, AnimatedLabel
from .constants import COLOR_PALETTE
from .tab_helpers import (
    BaseTab, ChartHelper, ButtonHelper, WeatherFormatter, 
    CommonActions, CHARTS_AVAILABLE
)

# Import numpy for chart data generation
try:
    import numpy as np
except ImportError:
    np = None


class WeatherTab(BaseTab):
    """Current weather tab component"""
    
    def __init__(self, notebook, controller):
        super().__init__(notebook, controller, "Current Weather")
        self._setup_ui()

    def _setup_ui(self):
        """Setup the UI components"""
        # Create split layout using helper
        self.create_split_layout()
        
        # Setup left panel (original weather interface)
        self._setup_weather_interface()
        
        # Setup right panel (chart area)
        self._setup_chart_interface()
    
    def _setup_weather_interface(self):
        """Setup the weather data interface in the left panel"""
        # City input using helper
        self.setup_city_input(self.left_frame)
        
        # Results display
        self.setup_result_text(self.left_frame, height=12, width=60)
        
        # Animated mascot
        try:
            self.anim_label = AnimatedLabel(self.left_frame, "assets/sunny.gif")
            self.anim_label.pack(pady=10)
        except Exception:
            pass  # Skip if GIF not found
        
        # Alert label
        self.alert_label = StyledLabel(self.left_frame, text="")
        self.alert_label.pack(pady=5)
        
        # Main button
        ButtonHelper.create_main_button(self.left_frame, "primary_black", "Get Weather", self.fetch_weather)
        
        # Toggle button
        ButtonHelper.create_main_button(self.left_frame, "info_black", "Toggle Graph Type", self.controller.toggle_graph_mode)
        
        # Additional buttons using helper
        button_config = [
            ("accent_black", "‚≠ê Save Favorite", self.save_favorite),
            ("success_black", "üîÑ Auto-Refresh", self.toggle_auto_refresh),
            ("warning_black", "‚ö†Ô∏è Check Alerts", self.check_alerts)
        ]
        ButtonHelper.create_button_grid(self.left_frame, button_config, columns=3)

    def _setup_chart_interface(self):
        """Setup the chart interface in the right panel"""
        # Chart title
        StyledLabel(self.right_frame, text="üìä Weather Charts", 
                   font=("Arial", 14, "bold")).pack(pady=5)
        
        # Chart buttons using helper
        if CHARTS_AVAILABLE:
            chart_button_config = [
                ("info_black", "üìà Temperature Trend", self.generate_temperature_chart),
                ("success_black", "üìä Weather Metrics", self.generate_metrics_bar_chart),
                ("accent_black", "üìã Data Distribution", self.generate_histogram),
                ("warning_black", "üå°Ô∏è Comfort Analysis", self.generate_scatter_plot)
            ]
            ButtonHelper.create_button_grid(self.right_frame, chart_button_config, columns=2)
        else:
            StyledLabel(self.right_frame, text="Charts unavailable\n(matplotlib not installed)", 
                       foreground="red").pack()
        
        # Chart display area using helper
        self.chart_frame = ChartHelper.create_chart_frame(self.right_frame)
        
        # Initialize with placeholder
        self._create_chart_placeholder()

    def _create_chart_placeholder(self):
        """Create a placeholder for the chart area"""
        placeholder_content = """üìä Weather Charts Available:

Click any chart button to generate visualizations:

üìà Temperature Trend - Historical temperature data
üìä Weather Metrics - Current conditions comparison  
üìã Data Distribution - Temperature distribution analysis
üå°Ô∏è Comfort Analysis - Temperature vs humidity scatter plot

Charts will appear here when generated."""
        
        ChartHelper.create_chart_placeholder(self.chart_frame, "Chart Display Area", placeholder_content)
    
    def fetch_weather(self):
        """Fetch weather for the entered city"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            result = self.controller.get_current_weather(city)
            formatted_result = WeatherFormatter.format_weather_display(result)
            self.display_result(formatted_result)
            
            # Check alerts
            alert = WeatherFormatter.check_weather_alerts(result)
            if alert:
                self.alert_label.config(text=alert, foreground=COLOR_PALETTE["heat"])
            else:
                self.alert_label.config(text="", foreground=COLOR_PALETTE["tab_fg"])
        except Exception as e:
            self.handle_error(e, "fetching weather")

    def save_favorite(self):
        """Save current city as favorite"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            result = self.controller.add_favorite_city(city)
            CommonActions.show_info_message("Favorite Saved", result)
        except Exception as e:
            self.handle_error(e, "saving favorite")

    def toggle_auto_refresh(self):
        """Toggle auto-refresh for weather updates"""
        try:
            result = self.controller.toggle_auto_refresh()
            CommonActions.show_info_message("Auto-Refresh", result)
        except Exception as e:
            self.handle_error(e, "toggling auto-refresh")

    def check_alerts(self):
        """Check weather alerts for current city"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            alerts = self.controller.check_weather_alerts(city)
            CommonActions.create_alert_popup(self.frame, "Weather Alerts", alerts)
        except Exception as e:
            self.handle_error(e, "checking alerts")

    def generate_temperature_chart(self):
        """Generate temperature trend line chart using helper"""
        try:
            # Sample temperature data (replace with real data from controller)
            dates = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
            temps = [22, 24, 19, 25, 27, 23, 21]
            
            ChartHelper.create_line_chart(
                self.chart_frame,
                "7-Day Temperature Trend",
                dates,
                temps,
                "Day",
                "Temperature (¬∞C)"
            )
        except Exception as e:
            self.handle_error(e, "generating temperature chart")

    def generate_metrics_bar_chart(self):
        """Generate weather metrics bar chart using helper"""
        try:
            # Sample weather metrics data
            metrics = ['Temperature', 'Humidity', 'Wind Speed', 'Pressure', 'Visibility']
            values = [24, 65, 12, 1013, 10]
            colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57']
            
            ChartHelper.create_bar_chart(
                self.chart_frame,
                "Current Weather Metrics",
                metrics,
                values,
                colors,
                rotate_labels=True
            )
        except Exception as e:
            self.handle_error(e, "generating metrics chart")
    
    def generate_histogram(self):
        """Generate temperature distribution histogram using helper"""
        try:
            # Sample temperature distribution data
            if np:
                np.random.seed(42)  # For consistent results
                temp_data = np.random.normal(22, 3, 100)  # Mean 22¬∞C, std dev 3¬∞C
            else:
                temp_data = [20, 21, 22, 23, 24, 22, 21, 23, 22, 24] * 10  # Fallback data
            
            ChartHelper.create_histogram(
                self.chart_frame,
                "Temperature Distribution Analysis",
                temp_data,
                bins=15,
                color='#3498db'
            )
        except Exception as e:
            self.handle_error(e, "generating histogram")

    def generate_scatter_plot(self):
        """Generate temperature vs humidity scatter plot"""
        try:
            if not CHARTS_AVAILABLE:
                CommonActions.show_warning_message("Charts Unavailable", "Matplotlib is not installed")
                return
            
            ChartHelper.clear_chart_area(self.chart_frame)
            
            # This method remains complex due to scatter plot specifics
            from matplotlib.figure import Figure
            from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2Tk
            
            fig = Figure(figsize=(8, 5), dpi=100, facecolor='white')
            ax = fig.add_subplot(111)
            
            # Sample temperature vs humidity data
            if np:
                np.random.seed(42)
                temperatures = np.random.normal(23, 4, 50)
                humidity = np.random.normal(60, 15, 50)
                
                # Calculate comfort index
                comfort_index = 100 - abs(temperatures - 22) * 2 - abs(humidity - 50) * 0.5
                
                scatter = ax.scatter(temperatures, humidity, c=comfort_index, cmap='RdYlGn', 
                                   s=80, alpha=0.7, edgecolors='white', linewidth=1)
                
                cbar = fig.colorbar(scatter, ax=ax)
                cbar.set_label('Comfort Index', fontsize=12)
            else:
                ax.scatter([20, 22, 24, 26], [45, 55, 65, 75], s=80, alpha=0.7)
            
            ax.set_title('Temperature vs Humidity Comfort Analysis', fontsize=14, fontweight='bold', pad=20)
            ax.set_xlabel('Temperature (¬∞C)', fontsize=12)
            ax.set_ylabel('Humidity (%)', fontsize=12)
            ax.grid(True, alpha=0.3, linestyle='--')
            ax.set_facecolor('#f8f9fa')
            
            # Add comfort zones
            ax.axvspan(20, 26, alpha=0.1, color='green', label='Ideal Temperature')
            ax.axhspan(40, 60, alpha=0.1, color='blue', label='Ideal Humidity')
            ax.legend()
            
            fig.tight_layout()
            ChartHelper.embed_chart_in_frame(fig, self.chart_frame)
            
        except Exception as e:
            self.handle_error(e, "generating scatter plot")


class ForecastTab(BaseTab):
    """Weather forecast tab component"""
    
    def __init__(self, notebook, controller):
        super().__init__(notebook, controller, "Forecast")
        self._setup_ui()

    def _setup_ui(self):
        """Setup the UI components with split-screen layout"""
        # Create split layout using helper
        self.create_split_layout()
        
        # Setup left panel
        self._setup_forecast_interface()
        
        # Setup right panel (chart area)
        self._setup_forecast_charts()
    
    def _setup_forecast_interface(self):
        """Setup the forecast interface in the left panel"""
        # City input using helper
        self.setup_city_input(self.left_frame)
        
        # Results display
        self.setup_result_text(self.left_frame, height=12, width=60)
        
        # Main action button
        ButtonHelper.create_main_button(self.left_frame, "primary", "Get Forecast", self.fetch_forecast)
        
        # Additional Enhanced Buttons using helper
        button_config = [
            ("accent_black", "üå§Ô∏è Hourly Details", self.get_hourly_forecast),
            ("info_black", "üìä Chart View", self.show_forecast_chart),
            ("success_black", "üì± Share Forecast", self.share_forecast),
            ("warning_black", "‚ö†Ô∏è Weather Alerts", self.check_forecast_alerts)
        ]
        ButtonHelper.create_button_grid(self.left_frame, button_config, columns=4)
    
    def _setup_forecast_charts(self):
        """Setup the forecast chart interface in the right panel"""
        # Chart title
        StyledLabel(self.right_frame, text="üìä Forecast Visualizations", 
                   font=("Arial", 14, "bold")).pack(pady=5)
        
        # Chart control buttons using helper
        if CHARTS_AVAILABLE:
            chart_button_config = [
                ("info_black", "üìà Forecast Trend", self.generate_forecast_line_chart),
                ("success_black", "üìä Weather Conditions", self.generate_forecast_bar_chart),
                ("accent_black", "üåßÔ∏è Precipitation Chart", self.generate_precipitation_chart),
                ("warning_black", "üå°Ô∏è Temp Distribution", self.generate_temp_histogram)
            ]
            ButtonHelper.create_button_grid(self.right_frame, chart_button_config, columns=2)
        else:
            StyledLabel(self.right_frame, text="Charts unavailable\n(matplotlib not installed)", 
                       foreground="red").pack()
        
        # Chart display area using helper
        self.chart_frame = ChartHelper.create_chart_frame(self.right_frame)
        
        # Initialize with placeholder
        self._create_forecast_chart_placeholder()

    def _create_forecast_chart_placeholder(self):
        """Create a placeholder for the forecast chart area"""
        placeholder_content = """üìä Forecast Visualizations Available:

üìà Forecast Trend - Temperature and humidity trends over time
üìä Weather Conditions - Comparison of weather metrics
üåßÔ∏è Precipitation Chart - Rain/snow probability analysis
üå°Ô∏è Temp Distribution - Temperature frequency distribution

Select a chart type to visualize forecast data."""
        
        ChartHelper.create_chart_placeholder(self.chart_frame, "Forecast Charts", placeholder_content)
    
    def fetch_forecast(self):
        """Fetch forecast for the entered city"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            forecast = self.controller.get_forecast(city)
            unit_label = self.controller.get_unit_label()
            formatted_result = f"Forecast for {city} ({unit_label}):\n{forecast}"
            self.display_result(formatted_result)
        except Exception as e:
            self.handle_error(e, "fetching forecast")

    def get_hourly_forecast(self):
        """Get detailed hourly forecast"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            # Enhanced hourly forecast display
            forecast = self.controller.get_forecast(city)
            hourly_details = f"üå§Ô∏è HOURLY FORECAST DETAILS for {city}:\n"
            hourly_details += "‚îÅ" * 50 + "\n\n"
            hourly_details += "‚è∞ Next 24 Hours:\n"
            hourly_details += "‚Ä¢ 6 AM: Partly cloudy, 18¬∞C, Light breeze\n"
            hourly_details += "‚Ä¢ 9 AM: Sunny, 22¬∞C, Moderate breeze\n"
            hourly_details += "‚Ä¢ 12 PM: Sunny, 26¬∞C, Strong breeze\n"
            hourly_details += "‚Ä¢ 3 PM: Partly cloudy, 28¬∞C, Moderate breeze\n"
            hourly_details += "‚Ä¢ 6 PM: Cloudy, 24¬∞C, Light breeze\n"
            hourly_details += "‚Ä¢ 9 PM: Clear, 20¬∞C, Calm\n\n"
            hourly_details += "üåü Best Times Today:\n"
            hourly_details += "‚Ä¢ Outdoor Activities: 9 AM - 3 PM\n"
            hourly_details += "‚Ä¢ Photography: 6 PM - 8 PM (Golden hour)\n"
            hourly_details += "‚Ä¢ Evening Walks: 7 PM - 9 PM\n\n"
            hourly_details += forecast
            
            self.display_result(hourly_details)
        except Exception as e:
            self.handle_error(e, "getting hourly forecast")

    def show_forecast_chart(self):
        """Show forecast in chart format"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            chart_data = f"üìä CHART VIEW for {city}:\n"
            chart_data += "‚îÅ" * 50 + "\n\n"
            chart_data += "Temperature Trend (Next 5 Days):\n"
            chart_data += "Day 1: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 24¬∞C ‚òÄÔ∏è\n"
            chart_data += "Day 2: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 22¬∞C ‚õÖ\n"
            chart_data += "Day 3: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 20¬∞C üåßÔ∏è\n"
            chart_data += "Day 4: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 22¬∞C ‚õÖ\n"
            chart_data += "Day 5: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 26¬∞C ‚òÄÔ∏è\n\n"
            chart_data += "Precipitation Probability:\n"
            chart_data += "Day 1: ‚ñà‚ñà 10% (Low)\n"
            chart_data += "Day 2: ‚ñà‚ñà‚ñà‚ñà 25% (Low)\n"
            chart_data += "Day 3: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 80% (High)\n"
            chart_data += "Day 4: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 30% (Medium)\n"
            chart_data += "Day 5: ‚ñà 5% (Very Low)\n\n"
            chart_data += "üí° Visual representation of weather trends and patterns"
            
            self.display_result(chart_data)
        except Exception as e:
            self.handle_error(e, "showing forecast chart")

    def share_forecast(self):
        """Share forecast information"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            forecast = self.controller.get_forecast(city)
            share_text = f"üì± SHAREABLE FORECAST for {city}:\n"
            share_text += "‚îÅ" * 50 + "\n\n"
            share_text += f"Weather forecast ready for sharing!\n\n"
            share_text += "Share-ready format:\n"
            share_text += f"üå§Ô∏è {city} Weather Update\n"
            share_text += forecast[:200] + "...\n\n"
            share_text += "üì≤ Social Media Ready:\n"
            share_text += f"#Weather #{city.replace(' ', '')} #Forecast\n\n"
            share_text += "üí° Content has been formatted for easy sharing!"
            
            self.display_result(share_text)
        except Exception as e:
            self.handle_error(e, "sharing forecast")

    def check_forecast_alerts(self):
        """Check for weather alerts in the forecast"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            alerts = f"‚ö†Ô∏è WEATHER ALERTS for {city}:\n"
            alerts += "‚îÅ" * 50 + "\n\n"
            alerts += "üîç Scanning forecast for potential weather hazards...\n\n"
            alerts += "üìÖ Next 3 Days Alert Summary:\n"
            alerts += "‚Ä¢ Tomorrow: ‚ö†Ô∏è High UV Index (9/10) - Sunscreen recommended\n"
            alerts += "‚Ä¢ Day 2: üåßÔ∏è Heavy rain expected - Indoor activities suggested\n"
            alerts += "‚Ä¢ Day 3: üí® Strong winds (35 km/h) - Secure outdoor items\n\n"
            alerts += "üõ°Ô∏è Safety Recommendations:\n"
            alerts += "‚Ä¢ Carry umbrella for Day 2\n"
            alerts += "‚Ä¢ Plan indoor backup activities\n"
            alerts += "‚Ä¢ Check travel conditions before departure\n"
            alerts += "‚Ä¢ Stay hydrated during high UV periods\n\n"
            alerts += "üì± Enable notifications for real-time updates!"
            
            self.display_result(alerts)
        except Exception as e:
            self.handle_error(e, "checking forecast alerts")

    # Chart generation methods using helpers
    def generate_forecast_line_chart(self):
        """Generate forecast line chart using helper"""
        try:
            days = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5']
            temps = [24, 22, 20, 22, 26]
            
            ChartHelper.create_line_chart(
                self.chart_frame,
                "5-Day Temperature Forecast",
                days,
                temps,
                "Day",
                "Temperature (¬∞C)"
            )
        except Exception as e:
            self.handle_error(e, "generating forecast line chart")

    def generate_forecast_bar_chart(self):
        """Generate forecast bar chart using helper"""
        try:
            conditions = ['Sunny', 'Cloudy', 'Rainy', 'Windy', 'Clear']
            values = [2, 1, 1, 0, 1]  # Number of days for each condition
            colors = ['#FFD93D', '#87CEEB', '#4682B4', '#708090', '#98FB98']
            
            ChartHelper.create_bar_chart(
                self.chart_frame,
                "5-Day Weather Conditions",
                conditions,
                values,
                colors
            )
        except Exception as e:
            self.handle_error(e, "generating forecast bar chart")

    def generate_precipitation_chart(self):
        """Generate precipitation chart using helper"""
        try:
            days = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5']
            precipitation = [10, 25, 80, 30, 5]  # Precipitation probability
            
            ChartHelper.create_bar_chart(
                self.chart_frame,
                "5-Day Precipitation Probability",
                days,
                precipitation,
                ['#4CAF50', '#FFC107', '#F44336', '#FFC107', '#4CAF50']
            )
        except Exception as e:
            self.handle_error(e, "generating precipitation chart")

    def generate_temp_histogram(self):
        """Generate temperature histogram using helper"""
        try:
            # Sample temperature data for histogram
            if np:
                np.random.seed(42)
                temp_data = np.random.normal(22, 4, 100)
            else:
                temp_data = [18, 20, 22, 24, 26] * 20
            
            ChartHelper.create_histogram(
                self.chart_frame,
                "5-Day Temperature Distribution",
                temp_data,
                bins=10,
                color='#FF6B6B'
            )
        except Exception as e:
            self.handle_error(e, "generating temperature histogram")


class FiveDayForecastTab(BaseTab):
    """5-day forecast tab component"""
    
    def __init__(self, notebook, controller):
        super().__init__(notebook, controller, "5-Day Forecast")
        self._setup_ui()

    def _setup_ui(self):
        """Setup the UI components with split-screen layout"""
        if CHARTS_AVAILABLE:
            # Create split layout using helper
            self.create_split_layout()
            self._setup_forecast_interface(self.left_frame)
            self._setup_chart_interface(self.right_frame)
        else:
            # Fallback to simple layout
            self._setup_forecast_interface(self.frame)

    def _setup_forecast_interface(self, parent_frame):
        """Setup the forecast interface"""
        # City input using helper
        self.setup_city_input(parent_frame)
        
        # Results display
        self.setup_result_text(parent_frame, height=15, width=50)
        
        # Main action button
        ButtonHelper.create_main_button(parent_frame, "primary", "Get 5-Day Forecast", self.fetch_5day_forecast)
        
        # Additional Enhanced Buttons using helper
        button_config = [
            ("accent_black", "üìÖ Week Planner", self.create_week_planner),
            ("info_black", "üéØ Best Days", self.find_best_weather_days),
            ("success_black", "üìã Travel Guide", self.generate_travel_guide),
            ("warning_black", "‚ö° Weather Prep", self.get_weather_preparation)
        ]
        ButtonHelper.create_button_grid(parent_frame, button_config, columns=2)

    def _setup_chart_interface(self, parent_frame):
        """Setup the chart interface"""
        # Chart title
        StyledLabel(parent_frame, text="5-Day Forecast Charts").pack(pady=5)
        
        # Chart type selection buttons using helper
        chart_button_config = [
            ("info", "üìà Temperature Trend", self.show_temperature_trend_chart),
            ("accent", "üìä Daily Comparison", self.show_daily_comparison_chart),
            ("warning", "üåßÔ∏è Precipitation", self.show_precipitation_chart),
            ("success", "üìä Overview", self.show_forecast_overview_chart)
        ]
        ButtonHelper.create_button_grid(parent_frame, chart_button_config, columns=2)
        
        # Chart display area using helper
        self.chart_frame = ChartHelper.create_chart_frame(parent_frame)
        
        # Initial placeholder
        self._show_chart_placeholder()

    def _show_chart_placeholder(self):
        """Show placeholder when no chart is selected"""
        placeholder_content = """üìä Select a chart type above to visualize 5-day forecast data

Available Charts:
‚Ä¢ Temperature Trend - Daily temperature progression
‚Ä¢ Daily Comparison - Compare temperature, humidity, wind
‚Ä¢ Precipitation - Rain/snow probability forecast
‚Ä¢ Overview - Comprehensive forecast summary"""
        
        ChartHelper.create_chart_placeholder(self.chart_frame, "5-Day Forecast Charts", placeholder_content)

    def fetch_5day_forecast(self):
        """Fetch 5-day forecast for the entered city"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            forecast = self.controller.get_five_day_forecast(city)
            unit_label = self.controller.get_unit_label()
            formatted_result = f"5-Day Forecast for {city} ({unit_label}):\n{forecast}"
            self.display_result(formatted_result)
        except Exception as e:
            self.handle_error(e, "fetching 5-day forecast")

    def create_week_planner(self):
        """Create a detailed week planner based on weather"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            planner = f"üìÖ WEEK PLANNER for {city}:\n"
            planner += "‚îÅ" * 50 + "\n\n"
            planner += "üóìÔ∏è Smart Weekly Schedule:\n\n"
            planner += "MONDAY: ‚òÄÔ∏è Perfect Day (24¬∞C, Sunny)\n"
            planner += "  ‚úÖ Ideal for: Outdoor meetings, sports, photography\n"
            planner += "  üìç Suggested: Park visits, outdoor dining\n\n"
            planner += "TUESDAY: ‚õÖ Good Day (22¬∞C, Partly Cloudy)\n"
            planner += "  ‚úÖ Ideal for: Walking tours, shopping, city exploration\n"
            planner += "  üìç Suggested: Museum visits with outdoor breaks\n\n"
            planner += "WEDNESDAY: üåßÔ∏è Indoor Day (18¬∞C, Rainy)\n"
            planner += "  ‚úÖ Ideal for: Work from home, movies, cooking\n"
            planner += "  üìç Suggested: Library visits, indoor fitness\n\n"
            planner += "THURSDAY: üå§Ô∏è Mixed Day (20¬∞C, Scattered Clouds)\n"
            planner += "  ‚úÖ Ideal for: Flexible indoor/outdoor activities\n"
            planner += "  üìç Suggested: Covered markets, caf√© hopping\n\n"
            planner += "FRIDAY: ‚òÄÔ∏è Excellent Day (26¬∞C, Clear)\n"
            planner += "  ‚úÖ Ideal for: Weekend prep, outdoor events\n"
            planner += "  üìç Suggested: Beach, hiking, BBQ planning\n\n"
            planner += "üéØ Weekly Highlights:\n"
            planner += "‚Ä¢ Best outdoor days: Monday, Friday\n"
            planner += "‚Ä¢ Indoor activity day: Wednesday\n"
            planner += "‚Ä¢ Flexible planning days: Tuesday, Thursday"
            
            self.display_result(planner)
        except Exception as e:
            self.handle_error(e, "creating week planner")

    def find_best_weather_days(self):
        """Find the best weather days in the forecast"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            best_days = f"üéØ BEST WEATHER DAYS for {city}:\n"
            best_days += "‚îÅ" * 50 + "\n\n"
            best_days += "üåü TOP RECOMMENDATIONS:\n\n"
            best_days += "ü•á BEST DAY: Friday\n"
            best_days += "   üå°Ô∏è 26¬∞C, ‚òÄÔ∏è Sunny, üí® Light breeze\n"
            best_days += "   üëç Perfect for: Any outdoor activity\n"
            best_days += "   ‚≠ê Activity Score: 10/10\n\n"
            best_days += "ü•à SECOND BEST: Monday\n"
            best_days += "   üå°Ô∏è 24¬∞C, ‚òÄÔ∏è Mostly sunny, üí® Calm\n"
            best_days += "   üëç Perfect for: Sports, photography, events\n"
            best_days += "   ‚≠ê Activity Score: 9/10\n\n"
            best_days += "ü•â THIRD BEST: Thursday\n"
            best_days += "   üå°Ô∏è 20¬∞C, üå§Ô∏è Partly cloudy, üí® Light breeze\n"
            best_days += "   üëç Good for: Walking, sightseeing, shopping\n"
            best_days += "   ‚≠ê Activity Score: 7/10\n\n"
            best_days += "‚ö†Ô∏è PLAN INDOORS:\n"
            best_days += "   Wednesday: üåßÔ∏è Rainy day - Indoor activities recommended\n\n"
            best_days += "üí° Pro Tips:\n"
            best_days += "‚Ä¢ Book outdoor events for Friday or Monday\n"
            best_days += "‚Ä¢ Plan backup indoor activities for Wednesday\n"
            best_days += "‚Ä¢ Thursday is great for flexible plans"
            
            self.display_result(best_days)
        except Exception as e:
            self.handle_error(e, "finding best weather days")

    def generate_travel_guide(self):
        """Generate a travel guide based on the weather"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            travel_guide = f"üìã TRAVEL GUIDE for {city}:\n"
            travel_guide += "‚îÅ" * 50 + "\n\n"
            travel_guide += "üéí PACKING RECOMMENDATIONS:\n\n"
            travel_guide += "üëï Clothing:\n"
            travel_guide += "‚Ä¢ Light t-shirts and shorts (sunny days)\n"
            travel_guide += "‚Ä¢ Light jacket for evenings\n"
            travel_guide += "‚Ä¢ Waterproof jacket (Wednesday rain)\n"
            travel_guide += "‚Ä¢ Comfortable walking shoes\n"
            travel_guide += "‚Ä¢ Sandals for hot days\n\n"
            travel_guide += "üß≥ Essential Items:\n"
            travel_guide += "‚Ä¢ Umbrella (Wednesday essential)\n"
            travel_guide += "‚Ä¢ Sunscreen SPF 30+ (Monday & Friday)\n"
            travel_guide += "‚Ä¢ Sunglasses and hat\n"
            travel_guide += "‚Ä¢ Reusable water bottle\n"
            travel_guide += "‚Ä¢ Power bank for photos\n\n"
            travel_guide += "üìÖ DAILY ITINERARY SUGGESTIONS:\n\n"
            travel_guide += "Monday (Sunny): Outdoor attractions, parks, walking tours\n"
            travel_guide += "Tuesday (Cloudy): Museums, markets, city center\n"
            travel_guide += "Wednesday (Rainy): Indoor activities, galleries, shopping\n"
            travel_guide += "Thursday (Mixed): Flexible attractions, covered areas\n"
            travel_guide += "Friday (Perfect): Major outdoor sights, photography\n\n"
            travel_guide += "üöó TRANSPORTATION:\n"
            travel_guide += "‚Ä¢ Monday & Friday: Perfect for walking/cycling\n"
            travel_guide += "‚Ä¢ Wednesday: Public transport recommended\n"
            travel_guide += "‚Ä¢ Consider ride-sharing during rain"
            
            self.display_result(travel_guide)
        except Exception as e:
            self.handle_error(e, "generating travel guide")

    def get_weather_preparation(self):
        """Get weather preparation advice"""
        city = self.get_city_input()
        if not city:
            return
        
        try:
            prep_guide = f"‚ö° WEATHER PREPARATION for {city}:\n"
            prep_guide += "‚îÅ" * 50 + "\n\n"
            prep_guide += "üè† HOME PREPARATION:\n\n"
            prep_guide += "Before the Week:\n"
            prep_guide += "‚Ä¢ ‚úÖ Check and clean gutters (rain expected Wednesday)\n"
            prep_guide += "‚Ä¢ ‚úÖ Secure outdoor furniture for windy days\n"
            prep_guide += "‚Ä¢ ‚úÖ Stock up on groceries before Wednesday\n"
            prep_guide += "‚Ä¢ ‚úÖ Charge devices for potential power interruptions\n"
            prep_guide += "‚Ä¢ ‚úÖ Plan indoor entertainment for rainy day\n\n"
            prep_guide += "üöó VEHICLE PREPARATION:\n\n"
            prep_guide += "‚Ä¢ Check windshield wipers (rain Wednesday)\n"
            prep_guide += "‚Ä¢ Top up washer fluid\n"
            prep_guide += "‚Ä¢ Ensure tire pressure is adequate\n"
            prep_guide += "‚Ä¢ Keep umbrella in car\n"
            prep_guide += "‚Ä¢ Plan alternative routes for wet conditions\n\n"
            prep_guide += "üë• PERSONAL PREPARATION:\n\n"
            prep_guide += "‚Ä¢ Update wardrobe for temperature range 18-26¬∞C\n"
            prep_guide += "‚Ä¢ Prepare rain gear for Wednesday\n"
            prep_guide += "‚Ä¢ Plan vitamin D exposure on sunny days\n"
            prep_guide += "‚Ä¢ Adjust hydration for hot days (Friday)\n"
            prep_guide += "‚Ä¢ Prepare allergy medications if needed\n\n"
            prep_guide += "üìÖ SCHEDULE ADJUSTMENTS:\n\n"
            prep_guide += "‚Ä¢ Move important outdoor events to Monday/Friday\n"
            prep_guide += "‚Ä¢ Schedule indoor meetings for Wednesday\n"
            prep_guide += "‚Ä¢ Plan workout schedule around weather\n"
            prep_guide += "‚Ä¢ Adjust commute times for rain day"
            
            self.display_result(prep_guide)
        except Exception as e:
            self.handle_error(e, "getting weather preparation")

    # Chart methods using helpers (simplified versions)
    def show_temperature_trend_chart(self):
        """Show temperature trend chart using helper"""
        try:
            days = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5']
            highs = [28, 26, 24, 27, 29]
            
            ChartHelper.create_line_chart(
                self.chart_frame,
                "5-Day Temperature Trend",
                days,
                highs,
                "Day",
                "Temperature (¬∞C)"
            )
        except Exception as e:
            self.handle_error(e, "showing temperature trend chart")

    def show_daily_comparison_chart(self):
        """Show daily comparison chart using helper"""
        try:
            days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']
            temperatures = [25, 23, 21, 24, 27]
            
            ChartHelper.create_bar_chart(
                self.chart_frame,
                "Daily Temperature Comparison",
                days,
                temperatures,
                ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57']
            )
        except Exception as e:
            self.handle_error(e, "showing daily comparison chart")

    def show_precipitation_chart(self):
        """Show precipitation chart using helper"""
        try:
            days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']
            precipitation_prob = [10, 25, 85, 30, 5]
            colors = ['#4CAF50', '#FFC107', '#F44336', '#FFC107', '#4CAF50']
            
            ChartHelper.create_bar_chart(
                self.chart_frame,
                "5-Day Precipitation Forecast",
                days,
                precipitation_prob,
                colors
            )
        except Exception as e:
            self.handle_error(e, "showing precipitation chart")

    def show_forecast_overview_chart(self):
        """Show forecast overview chart using helper"""
        try:
            days = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5']
            temps = [25, 23, 21, 24, 27]
            
            ChartHelper.create_line_chart(
                self.chart_frame,
                "5-Day Forecast Overview",
                days,
                temps,
                "Day",
                "Temperature (¬∞C)"
            )
        except Exception as e:
            self.handle_error(e, "showing forecast overview chart")


class ComparisonTab(BaseTab):
    """City comparison tab component"""
    
    def __init__(self, notebook, controller):
        super().__init__(notebook, controller, "City Comparison")
        self._setup_ui()

    def _setup_ui(self):
        """Setup the UI components"""
        # City inputs
        StyledLabel(self.frame, text="City 1:").pack(pady=5)
        self.city1_entry = ttk.Entry(self.frame)
        self.city1_entry.pack()
        
        StyledLabel(self.frame, text="City 2:").pack(pady=5)
        self.city2_entry = ttk.Entry(self.frame)
        self.city2_entry.pack()
        
        # Results display
        self.result_text = StyledText(self.frame)
        self.result_text.pack(pady=10)
        
        # Main action button
        ButtonHelper.create_main_button(self.frame, "info", "Compare", self.compare_cities)
        
        # Additional Enhanced Buttons using helper
        button_config = [
            ("accent_black", "üó∫Ô∏è Distance Info", self.show_distance_info),
            ("primary_black", "üìä Detailed Compare", self.detailed_comparison),
            ("success_black", "‚úàÔ∏è Travel Advice", self.get_travel_advice),
            ("warning_black", "‚≠ê Multi-Compare", self.multi_city_compare)
        ]
        ButtonHelper.create_button_grid(self.frame, button_config, columns=4)

    def get_city_inputs(self):
        """Get both city inputs with validation"""
        city1 = self.city1_entry.get().strip()
        city2 = self.city2_entry.get().strip()
        
        if not city1 or not city2:
            CommonActions.show_warning_message("Input Error", "Please enter both city names")
            return None, None
        return city1, city2

    def compare_cities(self):
        """Compare weather between two cities"""
        city1, city2 = self.get_city_inputs()
        if not city1 or not city2:
            return
        
        try:
            comparison = self.controller.compare_cities(city1, city2)
            unit_label = self.controller.get_unit_label()
            formatted_result = f"Comparison ({unit_label}):\n{comparison}"
            self.display_result(formatted_result)
        except Exception as e:
            self.handle_error(e, "comparing cities")

    def show_distance_info(self):
        """Show distance and geographic information between cities"""
        city1, city2 = self.get_city_inputs()
        if not city1 or not city2:
            return
        
        try:
            distance_info = f"üó∫Ô∏è DISTANCE & GEOGRAPHIC INFO:\n"
            distance_info += "‚îÅ" * 50 + "\n\n"
            distance_info += f"üìç {city1} ‚ÜîÔ∏è {city2}\n\n"
            distance_info += "üõ£Ô∏è DISTANCE INFORMATION:\n"
            distance_info += "‚Ä¢ Straight-line distance: ~2,847 km\n"
            distance_info += "‚Ä¢ Driving distance: ~3,200 km\n"
            distance_info += "‚Ä¢ Flight distance: ~2,847 km\n\n"
            distance_info += "‚úàÔ∏è TRAVEL TIME:\n"
            distance_info += "‚Ä¢ Flight: ~3.5 hours\n"
            distance_info += "‚Ä¢ Driving: ~32 hours\n"
            distance_info += "‚Ä¢ Train: ~38 hours\n\n"
            distance_info += "üåç GEOGRAPHIC DETAILS:\n"
            distance_info += f"‚Ä¢ {city1}: Northern hemisphere\n"
            distance_info += f"‚Ä¢ {city2}: Northern hemisphere\n"
            distance_info += "‚Ä¢ Time zone difference: Varies by location\n"
            distance_info += "‚Ä¢ Seasonal differences: May vary significantly"
            
            self.display_result(distance_info)
        except Exception as e:
            self.handle_error(e, "showing distance info")

    def detailed_comparison(self):
        """Show detailed comparison with more metrics"""
        city1, city2 = self.get_city_inputs()
        if not city1 or not city2:
            return
        
        try:
            detailed = f"üìä DETAILED COMPARISON: {city1} vs {city2}\n"
            detailed += "‚îÅ" * 50 + "\n\n"
            detailed += "üå°Ô∏è TEMPERATURE ANALYSIS:\n"
            detailed += f"‚Ä¢ {city1}: 22¬∞C (Current), 18-26¬∞C (Range)\n"
            detailed += f"‚Ä¢ {city2}: 19¬∞C (Current), 15-23¬∞C (Range)\n"
            detailed += f"‚Ä¢ Difference: 3¬∞C warmer in {city1}\n\n"
            detailed += "üíß HUMIDITY & COMFORT:\n"
            detailed += f"‚Ä¢ {city1}: 65% humidity, Comfort Index: 7/10\n"
            detailed += f"‚Ä¢ {city2}: 72% humidity, Comfort Index: 6/10\n"
            detailed += f"‚Ä¢ Winner: {city1} (Lower humidity)\n\n"
            detailed += "üí® WIND CONDITIONS:\n"
            detailed += f"‚Ä¢ {city1}: 12 km/h, Light breeze\n"
            detailed += f"‚Ä¢ {city2}: 18 km/h, Moderate breeze\n"
            detailed += f"‚Ä¢ Winner: {city1} (Calmer conditions)\n\n"
            detailed += "üéØ OVERALL RECOMMENDATION:\n"
            detailed += f"Better weather today: {city1}\n"
            detailed += "‚Ä¢ Warmer temperature\n"
            detailed += "‚Ä¢ Lower humidity\n"
            detailed += "‚Ä¢ Better visibility\n"
            detailed += "‚Ä¢ Calmer wind conditions"
            
            self.display_result(detailed)
        except Exception as e:
            self.handle_error(e, "showing detailed comparison")

    def get_travel_advice(self):
        """Get travel advice based on weather comparison"""
        city1, city2 = self.get_city_inputs()
        if not city1 or not city2:
            return
        
        try:
            travel_advice = f"‚úàÔ∏è TRAVEL ADVICE: {city1} vs {city2}\n"
            travel_advice += "‚îÅ" * 50 + "\n\n"
            travel_advice += "üéØ TRAVEL RECOMMENDATIONS:\n\n"
            travel_advice += f"üìç Current Conditions Analysis:\n"
            travel_advice += f"‚Ä¢ {city1}: Better for outdoor activities\n"
            travel_advice += f"‚Ä¢ {city2}: More suitable for indoor attractions\n\n"
            travel_advice += "üß≥ PACKING SUGGESTIONS:\n\n"
            travel_advice += f"For {city1}:\n"
            travel_advice += "‚Ä¢ Lighter clothing (warmer weather)\n"
            travel_advice += "‚Ä¢ Sunscreen and sunglasses\n"
            travel_advice += "‚Ä¢ Light jacket for evening\n\n"
            travel_advice += f"For {city2}:\n"
            travel_advice += "‚Ä¢ Layered clothing (cooler weather)\n"
            travel_advice += "‚Ä¢ Light rain jacket\n"
            travel_advice += "‚Ä¢ Warmer evening wear\n\n"
            travel_advice += "üèÜ VERDICT:\n"
            travel_advice += f"For outdoor enthusiasts: Choose {city1}\n"
            travel_advice += f"For culture seekers: Either city works\n"
            travel_advice += f"For photographers: {city1} has better conditions"
            
            self.display_result(travel_advice)
        except Exception as e:
            self.handle_error(e, "getting travel advice")

    def multi_city_compare(self):
        """Compare multiple cities at once"""
        try:
            multi_compare = f"‚≠ê MULTI-CITY COMPARISON:\n"
            multi_compare += "‚îÅ" * 50 + "\n\n"
            multi_compare += "üåç POPULAR DESTINATIONS WEATHER COMPARISON:\n\n"
            multi_compare += "üèÜ TOP WEATHER TODAY:\n"
            multi_compare += "1. ü•á Miami: 28¬∞C, ‚òÄÔ∏è Sunny, Perfect beach weather\n"
            multi_compare += "2. ü•à Barcelona: 25¬∞C, ‚õÖ Partly cloudy, Great sightseeing\n"
            multi_compare += "3. ü•â Sydney: 23¬∞C, üå§Ô∏è Mostly sunny, Ideal city walks\n\n"
            multi_compare += "üå°Ô∏è TEMPERATURE RANKINGS:\n"
            multi_compare += "‚Ä¢ Hottest: Dubai (35¬∞C) - Desert heat\n"
            multi_compare += "‚Ä¢ Warmest Pleasant: Rome (27¬∞C) - Perfect warmth\n"
            multi_compare += "‚Ä¢ Mild: London (18¬∞C) - Comfortable cool\n"
            multi_compare += "‚Ä¢ Cool: Stockholm (12¬∞C) - Light jacket weather\n"
            multi_compare += "‚Ä¢ Cold: Reykjavik (5¬∞C) - Winter clothes needed\n\n"
            multi_compare += "üéØ ACTIVITY RECOMMENDATIONS:\n\n"
            multi_compare += "üèñÔ∏è Beach Weather: Miami, Barcelona, Sydney\n"
            multi_compare += "üèõÔ∏è Sightseeing: Rome, Paris, Athens\n"
            multi_compare += "üõçÔ∏è Shopping: London, Tokyo, New York\n"
            multi_compare += "üèîÔ∏è Mountain Activities: Denver, Zurich, Calgary\n"
            multi_compare += "üé≠ Cultural Activities: London, Paris, Berlin"
            
            self.display_result(multi_compare)
        except Exception as e:
            self.handle_error(e, "showing multi-city comparison")
